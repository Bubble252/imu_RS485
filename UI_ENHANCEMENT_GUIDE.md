# 🎮 UI增强功能使用指南

## ✨ 新增功能

### 1. **视频窗口键盘控制夹爪** ⭐
**问题**：之前只能在启动程序的终端按键盘才能控制夹爪  
**解决**：现在可以在视频窗口（OpenCV窗口）直接按键盘控制！

**使用方法**：
1. 启动程序后，点击任意一个视频窗口（`Left Wrist Camera` 或 `Top Camera`）
2. 确保窗口获得焦点（窗口标题栏高亮）
3. 按键盘：
   - **按住 `1`**：夹爪持续打开
   - **按住 `2`**：夹爪持续闭合
   - **按 `q`**：退出程序

**优势**：
- ✅ 无需切换到终端窗口
- ✅ 视频窗口和控制在同一个界面
- ✅ 视觉反馈更直观

---

### 2. **夹爪状态可视化条** 📊
在视频画面底部显示实时夹爪开合程度。

**显示内容**：
- 进度条：显示当前夹爪开合值（0.0 - 1.0）
- 颜色编码：
  - 🔴 **红色**（0.0 - 0.3）：闭合状态
  - 🟡 **黄色**（0.3 - 0.7）：半开状态
  - 🟢 **绿色**（0.7 - 1.0）：打开状态
- 数值显示：精确到小数点后两位

**位置**：视频画面底部倒数第二行

**示例**：
```
┌─────────────────────────────┐
│     Video Feed Here         │
│                             │
│ Press '1' to Open...        │ ← 提示文字
│ ╔══════════════════╗        │ ← 夹爪状态条
│ ║████████░░░░░░░░░░║  0.45  │
│ ╚══════════════════╝        │
│ ╔══════════════════╗        │ ← 音频波形
│ ║～～～～～～～～～～║ [▓▓░] │
│ ╚══════════════════╝        │
└─────────────────────────────┘
```

---

### 3. **音频波形实时显示** 🔊
在视频画面最底部显示音频波形和音量表。

**显示内容**：

#### a) 波形图（左侧）
- 实时显示音频信号波形
- 绿色曲线，200像素宽
- 垂直范围：±15像素
- 更新频率：16.7 Hz（每60ms一帧）

#### b) 音量表（VU Meter，右侧）
- 80像素宽的横向条形图
- 颜色编码：
  - 🟢 **绿色**（低音量 < 30%）
  - 🟡 **黄色**（中音量 30-70%）
  - 🔴 **红色**（高音量 > 70%）
- 显示RMS音量值（归一化到0-1）

**位置**：视频画面最底部

**用途**：
- ✅ 实时监控音频接收状态
- ✅ 确认音频数据是否正常传输
- ✅ 检测音频延迟或丢包
- ✅ 调试音频问题时的可视化工具

---

## 🖥️ UI布局总览

```
┌─────────────────────────────────────────┐
│ Left Wrist - Frame: 1234        ┌─────┐ │ ← 顶部：摄像头信息
│ Latency: 127.5ms                │     │ │
│                                 │     │ │
│                                 │     │ │
│        [Video Content]          │     │ │
│                                 │     │ │
│                                 │     │ │
│                                 └─────┘ │
│                                         │
│ Press '1' to Open | '2' to Close...    │ ← 键盘提示
├─────────────────────────────────────────┤
│ Gripper: 0.45 (1=Open, 2=Close)        │ ← 夹爪状态条
│ ╔════════════════════════════════════╗ │
│ ║████████████░░░░░░░░░░░░░░░░░░░░░░░║ │ 红/黄/绿进度条
│ ╚════════════════════════════════════╝ │
├─────────────────────────────────────────┤
│ Audio  ┌──────────────┐  [Volume]      │ ← 音频面板
│        │ ～～～～～～ │  ████████░░    │
│        └──────────────┘                 │
└─────────────────────────────────────────┘
```

---

## 🚀 使用示例

### 场景1：机械臂遥操作
```bash
# 1. 启动程序（假设B端和SSH隧道已就绪）
cd ~/桌面/WIT_RS485
python triple_imu_rs485_publisher_dual_cam_UI_voice.py \
    --online-only \
    --b-host localhost --b-port 5555 \
    --enable-video --video-host localhost --video-port 5557 \
    --enable-audio --audio-host localhost --audio-port 5561 \
    -p /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0 \
    --enable-debug --debug-port 5560

# 2. 等待视频窗口出现（Left Wrist Camera 或 Top Camera）

# 3. 点击任意视频窗口获得焦点

# 4. 观察UI元素：
#    - 顶部：视频帧号、延迟
#    - 底部倒数第二行：夹爪状态条（颜色 + 数值）
#    - 底部最后一行：音频波形 + 音量表

# 5. 控制夹爪：
#    - 按住 '1' → 看到绿色进度条向右移动 → 夹爪打开
#    - 按住 '2' → 看到红色进度条向左移动 → 夹爪闭合
#    - 松开按键 → 进度条停止移动 → 夹爪停止

# 6. 监控音频：
#    - 说话时 → 看到波形振动、音量表填充（绿/黄/红）
#    - 安静时 → 波形平稳、音量表为空
#    - 如果波形不动 → 音频传输有问题
```

### 场景2：调试音频质量
```bash
# 启动程序后，观察音频面板：

# 正常情况：
# Audio  ┌──────────────┐  [Volume]
#        │ ～～～～～～ │  ████░░░░     ← 波形动态，音量合理
#        └──────────────┘

# 异常情况1：音频丢包
# Audio  ┌──────────────┐  [Volume]
#        │ ━━━━━━━━━━━ │  ░░░░░░░░     ← 波形平直，音量为0
#        └──────────────┘
# → 检查网络连接、B端是否运行

# 异常情况2：音频过载
# Audio  ┌──────────────┐  [Volume]
#        │ ▔▔▔▔▔▔▔▔▔▔▔ │  ██████████   ← 波形削顶，音量爆表（红色）
#        └──────────────┘
# → 降低C端麦克风增益：pactl set-source-volume @DEFAULT_SOURCE@ 60%

# 异常情况3：音频延迟抖动
# Audio  ┌──────────────┐  [Volume]
#        │ ～  ～  ～  ～│  ▓░▓░▓░▓░     ← 波形断断续续
#        └──────────────┘
# → 检查网络延迟、CPU占用
```

---

## 📊 技术细节

### 夹爪状态条
- **更新频率**：50 Hz（20ms间隔）
- **步长**：0.005 per update
- **范围**：0.0（完全闭合）到 1.0（完全打开）
- **实现**：`gripper_update_thread()` 线程持续更新
- **线程安全**：使用 `gripper_lock` 互斥锁保护

### 音频波形显示
- **数据来源**：`latest_audio_waveform` 全局变量
- **采样率**：48000 Hz
- **帧大小**：2880 样本（60ms）
- **降采样**：2880 → 256 点（用于显示）
- **更新频率**：16.7 Hz（每帧音频）
- **归一化**：int16 PCM → ±1.0 float → ±15 像素
- **线程安全**：使用 `audio_waveform_lock` 互斥锁保护

### 音量表（VU Meter）
- **计算方法**：RMS（Root Mean Square）
- **公式**：`RMS = sqrt(mean(samples^2)) / 32767`
- **范围**：0.0 - 1.0（归一化）
- **显示放大**：×2（更敏感）
- **颜色阈值**：
  - 绿色：< 0.3
  - 黄色：0.3 - 0.7
  - 红色：> 0.7

### 键盘监听机制
- **终端模式**：`tty.setcbreak()` 非缓冲模式
- **OpenCV模式**：`cv2.waitKey(1)` 每毫秒检测一次
- **双重监听**：终端和CV窗口同时有效
- **按键超时**：100ms 无重复则视为松开

---

## ⚙️ 配置选项

### 启用/禁用视频显示
```python
# 在代码中（或通过命令行参数）
ENABLE_VIDEO_DISPLAY = True   # 启用UI增强功能
ENABLE_VIDEO_DISPLAY = False  # 禁用（无UI，节省资源）
```

### 调整UI元素大小
编辑 `draw_enhanced_ui()` 函数：

```python
# 夹爪状态条高度
gripper_bar_height = 30  # 默认30像素，可调整为 20-50

# 音频面板高度
audio_panel_height = 35  # 默认35像素，可调整为 30-60

# 波形宽度
waveform_width = 200     # 默认200像素，可调整为 100-300

# 音量表宽度
volume_bar_width = 80    # 默认80像素，可调整为 50-120
```

### 调整音频波形灵敏度
```python
# 波形振幅（在 draw_enhanced_ui() 中）
waveform_pixels = (waveform_normalized * 15).astype(np.int32)
#                                          ↑
#                                      调整这个值
# 10 = 低灵敏度（小波形）
# 15 = 中等（默认）
# 20 = 高灵敏度（大波形）

# 音量表灵敏度
volume_fill = int(volume_bar_width * min(latest_audio_rms * 2, 1.0))
#                                                            ↑
#                                                        放大倍数
# 1 = 原始灵敏度
# 2 = 默认（更敏感）
# 3 = 高灵敏度
```

---

## 🐛 故障排查

### 问题1：夹爪状态条不更新
**症状**：进度条一直是灰色/不动  
**原因**：`gripper_update_thread` 未启动  
**解决**：检查启动日志，确认 "线程: 夹爪更新" 已启动

### 问题2：音频波形不显示
**症状**：音频面板是空的  
**原因**：
1. 音频未启用（`--enable-audio` 未指定）
2. 音频线程未接收到数据
3. `latest_audio_waveform` 为 None

**解决**：
```bash
# 检查音频线程日志
🔊 音频播放: 50 帧, 队列: 2/10, 下溢: 0  ← 应该看到这个

# 如果没有，检查：
1. B端是否运行？
2. SSH隧道端口5561是否转发？
3. C端是否发送音频？
```

### 问题3：视频窗口按键无效
**症状**：按 '1' '2' 没有反应  
**原因**：窗口未获得焦点  
**解决**：
1. 用鼠标点击视频窗口
2. 确保窗口标题栏高亮
3. 如果还是无效，使用终端按键（备用方案）

### 问题4：UI元素遮挡视频
**症状**：底部UI太大，看不到重要内容  
**原因**：UI高度占用过多  
**解决**：调整配置（见上文"调整UI元素大小"）

### 问题5：音量表一直红色
**症状**：音量表持续显示红色，可能爆音  
**原因**：C端麦克风增益过高  
**解决**：
```bash
# 降低麦克风音量到60%
pactl set-source-volume @DEFAULT_SOURCE@ 60%

# 或者在代码中降低灵敏度
volume_fill = int(volume_bar_width * min(latest_audio_rms * 1.5, 1.0))
#                                                            ↑↑↑
#                                                       从2改为1.5
```

---

## 🎯 最佳实践

### 1. 屏幕布局建议
```
┌─────────────────┬─────────────────┐
│                 │                 │
│  Left Wrist     │   Top Camera    │
│  (with UI)      │   (with UI)     │
│                 │                 │
│  夹爪: ███░░    │   夹爪: ███░░   │
│  音频: ～～～   │   音频: ～～～  │
└─────────────────┴─────────────────┘
         ↓                 ↓
    点击任意窗口控制夹爪
```

### 2. 键盘操作流程
1. **启动** → 等待视频窗口出现
2. **点击窗口** → 获得焦点（标题栏高亮）
3. **按住按键** → 观察夹爪条变化
4. **松开按键** → 夹爪停止
5. **切换窗口** → 两个视频窗口都可以控制

### 3. 音频监控要点
- ✅ **正常**：波形起伏自然，音量表绿色/黄色
- ⚠️ **警告**：波形断续，可能有丢包
- ❌ **异常**：波形不动，音频未接收

### 4. 性能优化
- 如果CPU占用过高，禁用一个视频窗口：
  ```python
  # 只显示左腕摄像头
  if camera_name == "Top":
      return frame  # 跳过UI绘制
  ```

---

## 📝 更新日志

### v2.0 - UI增强版
- ✅ 添加视频窗口键盘控制
- ✅ 添加夹爪状态可视化条
- ✅ 添加音频波形实时显示
- ✅ 添加音量表（VU Meter）
- ✅ 优化UI布局和提示文字

### v1.0 - 基础版
- 终端键盘控制
- 基础视频显示
- 音频传输（无可视化）

---

## 💡 未来改进方向

1. **PyQt5/GTK UI**：完整的GUI界面（非OpenCV窗口）
2. **触摸屏支持**：滑动控制夹爪
3. **手势识别**：用手势代替键盘
4. **音频录制**：保存音频到文件
5. **波形回放**：查看历史音频数据
6. **多通道音频**：立体声显示
7. **频谱分析**：FFT频域显示

---

## 🆘 需要帮助？

如果遇到问题，请检查：
1. 是否使用最新版本的代码
2. 是否安装了所有依赖（opencv-python, numpy, sounddevice, opuslib）
3. 是否启用了 `--enable-video` 和 `--enable-audio`
4. SSH隧道是否正常（6个端口）
5. B端和C端是否都在运行

详细调试信息请查看终端输出日志。
