# PyQt5 UI 集成测试指南

## 新增功能

### 1. 夹爪控制面板（GripperControlWidget）
- **键盘控制**：点击面板后，按住 `1` 打开夹爪，按住 `2` 闭合夹爪
- **按钮控制**：点击"打开"/"闭合"按钮，长按持续控制
- **滑动条**：拖动滑动条精确设置夹爪位置（0-100%）
- **预设按钮**：快速设置到 25%/50%/75% 位置
- **实时显示**：进度条显示当前夹爪开合度，颜色编码（红→黄→绿）

### 2. 音频波形面板（AudioWaveformWidget）
- **波形显示**：实时显示256个采样点的音频波形
- **音量条**：RMS音量可视化，0-100%，颜色渐变
- **状态指示**：显示帧数、FPS、下溢次数、接收状态

## 测试步骤

### 准备工作
1. 确保已安装PyQt5：
   ```bash
   pip install PyQt5
   ```

2. 确保主程序已添加音频可视化数据（已完成）

### 启动测试

#### 终端1：启动主控制程序（带UI命令接收）
```bash
cd /home/bubble/桌面/WIT_RS485
python triple_imu_rs485_publisher_dual_cam_UI_voice.py \
    --port /dev/ttyUSB0 \
    --b-host 192.168.1.100 \
    --enable-debug \
    --enable-audio \
    --online-only
```

**注意**：
- `--enable-debug` 必须启用，才能发布数据到UI（端口5560）
- UI命令接收端口默认5562，会自动启动
- 如果不需要音频，可去掉 `--enable-audio`

#### 终端2：启动PyQt5 UI
```bash
cd /home/bubble/桌面/WIT_RS485/pyqt5_viewer
python imu_dual_cam_viewer.py --host localhost --port 5560
```

### 功能测试

#### 测试1：夹爪键盘控制
1. 点击UI左侧的"夹爪控制"面板（获取焦点）
2. 按住键盘 `1` 键，观察：
   - UI进度条增加
   - 终端1打印：`🎮 [UI命令] 夹爪打开`
   - 实际夹爪开始打开
3. 松开 `1` 键，夹爪应停止
4. 按住键盘 `2` 键，观察夹爪闭合
5. 松开 `2` 键，夹爪停止

#### 测试2：夹爪按钮控制
1. 点击"打开"按钮（蓝色）
2. 观察夹爪持续打开
3. 点击"闭合"按钮（绿色）
4. 观察夹爪持续闭合
5. 再次点击已按下的按钮可停止

#### 测试3：夹爪滑动条控制
1. 拖动滑动条到 50%
2. 观察：
   - 终端1打印：`🎮 [UI命令] 夹爪设置为: 0.50`
   - 夹爪移动到对应位置
3. 点击预设按钮（25%/50%/75%）测试快速定位

#### 测试4：音频波形显示
1. 确保B端发送音频流（如果启用了音频）
2. 观察UI左侧"音频波形"面板：
   - 波形图应实时更新
   - 音量条应随音频变化
   - 帧数持续增加
   - "接收状态"显示为"✓ 接收中"
3. 如果没有音频输入，应显示"✗ 未接收"

#### 测试5：同步显示
1. 在终端1按住 `1` 键（终端键盘控制）
2. 观察UI夹爪进度条应同步更新
3. 反之，在UI按 `1` 键，终端应有反馈

## 通信架构

```
┌─────────────────────────────────────────────────────────────┐
│  triple_imu_rs485_publisher_dual_cam_UI_voice.py (主程序)    │
│                                                               │
│  ┌──────────────────┐      ┌──────────────────┐             │
│  │  夹爪控制线程     │      │  音频播放线程     │             │
│  │  (gripper_value) │      │  (保存波形数据)   │             │
│  └──────────────────┘      └──────────────────┘             │
│            ↑                         ↑                       │
│            │                         │                       │
│  ┌─────────┴─────────┐      ┌───────┴────────┐             │
│  │ UI命令接收线程     │      │ 调试数据发布    │             │
│  │ (PULL socket)     │      │ (PUB socket)   │             │
│  │ tcp://*:5562      │      │ tcp://*:5560   │             │
│  └───────────────────┘      └────────────────┘             │
└──────────│──────────────────────────│────────────────────────┘
           │                          │
           │ 命令                      │ 数据流
           │ (Pickle)                 │ (Pickle)
           │                          │
           ↓                          ↓
┌─────────────────────────────────────────────────────────────┐
│  imu_dual_cam_viewer.py (PyQt5 UI)                          │
│                                                               │
│  ┌──────────────────┐      ┌──────────────────┐             │
│  │ GripperControl   │      │ AudioWaveform    │             │
│  │ Widget           │      │ Widget           │             │
│  │ (发送命令)        │      │ (显示波形)        │             │
│  └──────────────────┘      └──────────────────┘             │
│                                                               │
│  ┌──────────────────┐      ┌──────────────────┐             │
│  │ 命令发送socket    │      │ ZMQ数据接收线程   │             │
│  │ (PUSH socket)    │      │ (SUB socket)     │             │
│  │ tcp://localhost:5562│    │ tcp://localhost:5560│         │
│  └──────────────────┘      └──────────────────┘             │
└─────────────────────────────────────────────────────────────┘
```

## 数据格式

### UI → 主程序（命令）
```python
# 夹爪开关命令
{
    "type": "gripper_command",
    "action": "open" | "close" | "stop"
}

# 夹爪精确值
{
    "type": "gripper_value",
    "value": 0.0-1.0
}
```

### 主程序 → UI（数据流）
```python
{
    "timestamp": 1234567890.123,
    "gripper": 0.5,  # 夹爪当前值
    "audio": {
        "waveform": [样本1, 样本2, ..., 样本256],  # int16数组
        "rms": 0.35,  # RMS音量 (0.0-1.0)
        "frame_count": 1234,
        "underrun_count": 0,
        "receiving": True
    },
    "imu1": {...},
    "imu2": {...},
    # ... 其他数据
}
```

## 故障排查

### 问题1：UI键盘无响应
- **原因**：面板未获取焦点
- **解决**：点击"夹爪控制"面板任意位置

### 问题2：命令无法发送
- **检查**：终端1是否打印 `✓ UI命令PULL socket已绑定到端口 5562`
- **检查**：UI是否打印 `✓ UI命令发送socket已连接到 tcp://localhost:5562`
- **解决**：确保主程序启动了ui_command_receiver_thread

### 问题3：音频波形不显示
- **检查**：主程序是否启用 `--enable-audio`
- **检查**：B端是否发送音频流
- **检查**：debug_data中是否包含"audio"字段
- **查看**：终端1是否有 `🔊 音频接收` 日志

### 问题4：UI夹爪进度条不同步
- **检查**：主程序是否启用 `--enable-debug`
- **检查**：debug_data中是否包含"gripper"字段
- **原因**：双向同步有延迟（正常现象）

## 端口分配总览

| 端口 | 模式 | 方向 | 说明 |
|------|------|------|------|
| 5555 | PUSH→PULL | A→B | 发送IMU数据到B端 |
| 5557 | PUB→SUB | B→A | 接收B端视频流 |
| 5559 | PUSH→PULL | A→LeRobot | 发送IMU数据到LeRobot |
| 5560 | PUB→SUB | 主程序→UI | 调试数据发布（包含所有传感器数据+视频+音频） |
| 5561 | PUB→SUB | B→A | 接收B端音频流 |
| 5562 | PUSH→PULL | UI→主程序 | UI控制命令（夹爪等） |

## 下一步扩展

- [ ] 添加命令历史记录
- [ ] 添加夹爪力反馈显示
- [ ] 音频频谱分析
- [ ] 命令宏录制/回放
- [ ] 手柄/游戏控制器支持
