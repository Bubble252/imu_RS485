# CH340 RS485设备使用指南

## 问题总结

您的CH340设备已被正确识别，但被**BRLTTY**（盲文显示器服务）干扰。

## 解决方案

### 方法1：快速解决（推荐）

```bash
# 1. 停止BRLTTY进程
sudo pkill brltty
sudo systemctl stop brltty
sudo systemctl disable brltty

# 2. 重新插拔CH340设备

# 3. 设置设备权限
sudo chmod 666 /dev/ttyUSB0

# 4. 运行测试程序
source .venv/bin/activate
python simple_test.py
```

### 方法2：永久解决BRLTTY冲突

编辑BRLTTY配置，排除CH340设备：

```bash
sudo nano /etc/brltty.conf
```

添加以下行：
```
device-parameters:usb:,exclude={idVendor=1a86}
```

### 方法3：完全卸载BRLTTY（如果不需要盲文支持）

```bash
sudo apt remove brltty
```

## 验证步骤

1. **检查USB设备识别**：
   ```bash
   lsusb | grep CH340
   # 应该显示: Bus 001 Device XXX: ID 1a86:7523 QinHeng Electronics CH340 serial converter
   ```

2. **检查驱动加载**：
   ```bash
   lsmod | grep ch341
   # 应该显示: ch341 24576 0
   ```

3. **检查串口设备**：
   ```bash
   ls -la /dev/ttyUSB0
   # 应该显示设备文件
   ```

4. **检查权限**：
   ```bash
   # 应该显示类似: crw-rw-rw- 1 root dialout 188, 0 Nov  5 13:xx /dev/ttyUSB0
   ```

## 使用您的RS485设备

一旦设备正常识别：

```bash
cd /home/bubble/桌面/WIT_RS485
source .venv/bin/activate
python simple_test.py
```

## 常见错误和解决方法

### 错误："Permission denied" 
**解决**：`sudo chmod 666 /dev/ttyUSB0`

### 错误："No such file or directory"
**解决**：设备被BRLTTY干扰，重新插拔设备并停止BRLTTY

### 错误："Device busy"
**解决**：其他程序占用串口，关闭相关程序

## 设备信息

- **您的设备**：CH340 USB转串口
- **对应串口**：/dev/ttyUSB0
- **波特率**：115200
- **Modbus地址**：0x50
- **厂商ID**：1a86:7523

## 自动化脚本

我已经为您创建了以下脚本：

1. `setup_ch340.sh` - 自动设置CH340设备
2. `simple_test.py` - 简化的测试程序
3. `find_serial_device.py` - 串口设备检测工具
4. `ch340_diagnostic.py` - CH340问题诊断工具

使用最简单的方法：
```bash
./setup_ch340.sh && python simple_test.py
```